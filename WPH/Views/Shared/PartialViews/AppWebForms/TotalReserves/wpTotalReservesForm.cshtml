
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor
@inject WPH.Resources.SharedViewLocalizer Localizer

@{
    string status_title = Localizer["ChangeToVisited"];
    string font = "", pull = "", direction = "";
    if (HttpContextAccessor.HttpContext.Session.GetString("culture") == "en")
    {
        font = " MyFont-Roboto-grid ";
        pull = " pull-left ";
        direction = " ";

    }
    else
    {
        font = " MyFont-Sarchia-grid ";
        pull = " pull-right ";
        direction = " direction:rtl; ";

    }
}

<div class="row page-header">
    <div class="@pull ">

        <h1 class="@font" style="font-size: 2.3rem">
            @Localizer["Reserve"]
        </h1>

    </div>
</div><!-- /.page-header -->

<h1 id="FromTo" class="hidden">@ViewBag.FromToId</h1>

<div class="row" style="margin-top:2rem">

    <div class=" col-sm-12">

        <div class="col-sm-4">
            @(Html.Kendo().DropDownList()
            .Name("periods")
            .DataTextField("Name")
            .DataValueField("Id")
            //.Filter("contains")
            .BindTo(@ViewBag.periods)
            .HtmlAttributes(new { style = "width: 100%;font-size:1.5rem", onchange = "PeriodsChange()" })
            )
        </div>

        <div class="col-sm-4">
            @(Html.Kendo().DropDownList()
            .Name("Doctor")
            .DataTextField("UserName")
            .DataValueField("Guid")
            .Filter("contains")
            .OptionLabel(" ")
            .DataSource(source =>
            {
                source.Read(read => { read.Action("GetDoctorsBaseUserAccess", "Doctor"); })
                .ServerFiltering(false);
            })
            .HtmlAttributes(new { style = "width: 100%;font-size:1.5rem", onchange = "PeriodsChange()" })
            )
        </div>

        <div class="col-sm-4">

        </div>

    </div>

    <div class="col-sm-12" style="margin-top:20px;display:flex;align-items: flex-end;">

        <div id="DateFromDiv" class=" col-sm-4 hidden">

            <label class="block clearfix" style="margin-bottom: 0px;">
                <label for="form-field-8">@Localizer["From"] @Localizer["Date"]:</label>

                <span class="block input-icon input-icon-right">

                    <input id="DateFrom" value="@DateTime.Now" title="datepicker" style="width: 100%;font-size:1.5rem" />

                </span>

            </label>
        </div>

        <div id="DateToDiv" class=" col-sm-4 hidden">

            <label class="block clearfix" style="margin-bottom: 0px;">
                <label for="form-field-8">@Localizer["To"] @Localizer["Date"]:</label>

                <span class="block input-icon input-icon-right">

                    <input id="DateTo" value="@DateTime.Now" title="datepicker" style="width: 100%;font-size:1.5rem" />

                </span>
            </label>
        </div>

        <div id="SearchBtnDiv" class="col-xs-1 hidden">

            @(Html.Kendo().Button()
            .Name("btn-search-visit")
            .HtmlAttributes(new { style = "font-size:1.5rem;padding:0.7rem", type = "button", @class = "k-primary pull-right", onclick = "btnSearchClick()" })
            .Content("<i class='fa fa-search'></i>"))

        </div>

    </div>
</div>


<script>

    function GetPeriodForAllVisits() {
        let period = $("#periods").data("kendoDropDownList");

        let periodValue = period.value();
        var DateFrom = $("#DateFrom").val();
        var DateTo = $("#DateTo").val();

        return {
            periodId: periodValue,
            dateFrom: DateFrom,
            dateTo: DateTo,
            doctorId: $("#Doctor").val()
        };
    }

</script>



<div class="row Grid-Content @font">
    @await Html.PartialAsync("~/Views/Shared/PartialViews/AppWebForms/TotalReserves/dgTotalReservesGrid.cshtml")
</div>



<div id="ShowReceiveModal" class="modal fade @font" data-backdrop="static" data-keyboard="false" style="@direction">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" onclick="closeReceiveModal()" aria-hidden="true">&times;</button>
                <h3 id="Receive-modal-header" class="smaller lighter blue no-margin @font">
                    @Localizer["Received"]
                </h3>
            </div>

            <div id="ShowReceiveModal-body" style="overflow:hidden;" class="modal-body">

            </div>

            <div id="ERROR_SomeThingWentWrong" class="red label-white middle hidden" style="height:40px;display:block">
                <i class="ace-icon fa fa-stop bigger-120"></i>
                @Localizer["ERROR_InsertWrong"]
            </div>

            <div id="EmptyDoctor" class="red label-white middle hidden" style="height:40px;display:block">
                <i class="ace-icon fa fa-stop bigger-120"></i>
                @Localizer["InsertDoctorName"]
            </div>

            <div id="ERROR_Data" class="red label-white middle hidden" style="height:40px;display:block">
                <i class="ace-icon fa fa-stop bigger-120"></i>
                @Localizer["ERROR_DataNotValid"]
            </div>

            <div id="InvalidReceptionService" class="red label-white middle hidden" style="height:40px;display:block">
                <i class="ace-icon fa fa-stop bigger-120"></i>
                @Localizer["InvalidReceptionService"]
            </div>

            <div id="NotEnoughProductCount" class="red label-white middle hidden" style="height:40px;display:block">
                <i class="ace-icon fa fa-stop bigger-120"></i>
                @Localizer["NotEnoughProductCount"]
            </div>


            <div class="modal-footer">
                @*@(Html.Kendo().Button()
                    .Name("btn-Receive-accept")
                    .HtmlAttributes(new { style = "font-size:15px;height:35px;margin:2px;", type = "button", @class = "k-primary pull-right", onclick = "()" })
                    .Content(Localizer["Ok"]))*@
                @(Html.Kendo().Button()
                        .Name("btn-ShowReceiveModal-close")
                        .HtmlAttributes(new { style = "font-size:15px;height:35px;margin:2px;", type = "button", @class = "pull-right", onclick = "closeReceiveModal()" })
                        .Content(Localizer["Exit"]))

            </div>
        </div>
    </div>
</div>

<div id="ConvertToVisitModal" class="modal fade @font" data-backdrop="static" data-keyboard="false" style="@direction">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="widget-header" style="padding:1rem">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h3 class='smaller @font'>
                    <i class='ace-icon fa fa-exclamation-triangle red '></i>@Localizer["SetReserveToVisited"]
                </h3>
            </div>

            <div id="ConvertToVisitModal-body" class="modal-body">
                @Localizer["SetReserveToVisitedBody"]

                <div id="ERROR_SomeThingWentWrong" class="red label-white middle hidden" style="height:40px;display:block">
                    <i class="ace-icon fa fa-stop bigger-120"></i>
                    @Localizer["ERROR_InsertWrong"]
                </div>

            </div>

            <div class="modal-footer">

                @(Html.Kendo().Button()
                    .Name("btn-ConvertToVisitModal-accept")
                    .HtmlAttributes(new { style = "font-size:15px;height:35px;margin:2px;", type = "button", @class = "k-primary pull-right" })
                    .Content(Localizer["Ok"]))
                @(Html.Kendo().Button()
                    .Name("btn-ConvertToVisitModal-close")
                    .HtmlAttributes(new { style = "font-size:15px;height:35px;margin:2px;", type = "button", @class = "pull-right", @data_dismiss = "modal" })
                    .Content(Localizer["Exit"]))
            </div>
        </div> @*.modal-content*@
    </div> @*.modal-dialog*@
</div>



@await Html.PartialAsync("~/Views/Shared/PartialViews/InterfacePartials/_GridAndModalLinks.cshtml")
@await Html.PartialAsync("~/Views/Shared/PartialViews/InterfacePartials/_Modal.cshtml")


<script>

    $(document).ready(function () {

        $("#DateFrom").kendoDatePicker({

            format: "dd/MM/yyyy"

        });

        $("#DateTo").kendoDatePicker({
            format: "dd/MM/yyyy"

        });
    })

    function LineItems_Databound(status) {
        if (status == 'Paid') {
            return "<div style='background:lightgreen;border-radius: 5px;'>" + status + " </div>";
        } else {
            return "<div style='background:pink;border-radius: 5px;'>" + status + " </div>";
        }
    }

    function ConvertToVisit_Databound(status,guid) {
        if (status == 'Visited') {
            return `<a class='tooltip-success grid-btn' data-rel='tooltip' title='Visited' data-original-title='Visited'>
                        <span class='green'>
                            <i class='ace-icon fa fa-check bigger-120'></i>
                        </span>
                    </a>`;
        } else {
            return `<a class='tooltip-success grid-btn' onClick='ConvertReserveToVisited(this);' data-id='${guid}' data-rel='tooltip' title='@status_title' data-original-title='ConvertToVisited'>
                        <span class='grey'>
                            <i class='ace-icon fa fa-check bigger-120'></i>
                        </span>
                    </a>`;
        }
    }

    function ConvertReserveToVisited(element) {

        $("#ConvertToVisitModal #ERROR_SomeThingWentWrong").addClass("hidden");

        $(".loader").removeClass("hidden");
        $('#ConvertToVisitModal').modal('toggle');
        var Id = $(element).attr('data-id');
        $('#btn-ConvertToVisitModal-accept').attr('data-id', Id);
        $(".loader").fadeIn("slow");
        $(".loader").addClass("hidden");
    }


    $('#btn-ConvertToVisitModal-accept').on("click", function () {
        $(this).attr("disabled", true);

        $("#ConvertToVisitModal #ERROR_SomeThingWentWrong").addClass("hidden");

        var Id = $(this).attr('data-id');
        var link = "/TotalReserves/ConvertToVisit";

        var token = $(':input:hidden[name*="RequestVerificationToken"]');
        $(".loader").removeClass("hidden");
        $.ajax({
            type: "Post",
            url: link,
            data: {
                __RequestVerificationToken: token.attr('value'),
                Id: Id
            },
            success: function (response) {
                $('#btn-ConvertToVisitModal-accept').removeAttr("disabled");

                if (response === 0) {

                    $("#ConvertToVisitModal #ERROR_SomeThingWentWrong").removeClass("hidden");
                    $(".loader").fadeIn("slow");
                    $(".loader").addClass("hidden");

                } else if (response === "Visited") {

                    $(".loader").fadeIn("slow");
                    $(".loader").addClass("hidden");

                } else {

                    $('#ConvertToVisitModal').modal('hide');
                    $(".modal-backdrop:last").remove();

                    $(".loader").fadeIn("slow");
                    $(".loader").addClass("hidden");
                    $("#kendoTotalReserveGrid").find(".k-pager-refresh").click();
                }

            }
        });
    });


    function PayVisitModal(element) {

        $("#ShowReceiveModal #ERROR_SomeThingWentWrong").addClass("hidden");
        $("#ShowReceiveModal #EmptyDoctor").addClass("hidden");
        $("#ShowReceiveModal #ERROR_Data").addClass("hidden");
        $("#TxtReserveDetailId").val(Id);

        $(".loader").removeClass("hidden");

        $('#ShowReceiveModal').modal('toggle');

        var link = "/Visit/PayVisitModal?reserveDetailId=";
        var Id = $(element).attr('data-id');

        $('#ShowReceiveModal-body').load(link + Id, function (responce) {

            if (responce === "NoVisit") {
                $('#ShowReceiveModal').modal('toggle');
                bootbox.alert({
                    message: reserveToQueue,
                    className: 'bootbox-class'
                });
            }

            $(".loader").fadeIn("slow");
            $(".loader").addClass("hidden");
        });
    }

    function closeReceiveModal() {

        $('#ShowReceiveModal').modal('hide');
        $('#ShowReceiveModal-body').empty();
        $(".modal-backdrop:last").remove();

    }


    function DeletePayVisitFunction(element) {

        $("#DeletePayVisitModal #ERROR_ThisRecordHasDependencyOnItInAnotherEntity").addClass("hidden");
        $("#DeletePayVisitModal #ERROR_SomeThingWentWrong").addClass("hidden");

        $(".loader").removeClass("hidden");
        $('#DeletePayVisitModal').modal('toggle');
        var Id = $(element).attr('data-id');
        $('#btn-DeletePayVisitModal-accept').attr('data-id', Id);
        $(".loader").fadeIn("slow");
        $(".loader").addClass("hidden");
    }


    $('#btn-DeletePayVisitModal-accept').on("click", function () {
        $(this).attr("disabled", true);
        
        $("#DeletePayVisitModal #ERROR_ThisRecordHasDependencyOnItInAnotherEntity").addClass("hidden");
        $("#DeletePayVisitModal #ERROR_SomeThingWentWrong").addClass("hidden");

        var Id = $(this).attr('data-id');
        var link = "/Visit/RemovePayVisit";

        var token = $(':input:hidden[name*="RequestVerificationToken"]');
        $(".loader").removeClass("hidden");
        $.ajax({
            type: "Post",
            url: link,
            data: {
                __RequestVerificationToken: token.attr('value'),
                Id: Id
            },
            success: function (response) {
                $('#btn-DeletePayVisitModal-accept').removeAttr("disabled");

                if (response === "SUCCESSFUL") {
                    $('#DeletePayVisitModal').modal('hide');
                    $(".modal-backdrop:last").remove();

                    $(".loader").fadeIn("slow");
                    $(".loader").addClass("hidden");
                    $("#serviceKendoGrid .k-pager-refresh")[0].click();

                }
                else if (response === "ERROR_ThisRecordHasDependencyOnItInAnotherEntity") {
                    $("#DeletePayVisitModal #ERROR_ThisRecordHasDependencyOnItInAnotherEntity").removeClass("hidden");
                    $(".loader").fadeIn("slow");
                    $(".loader").addClass("hidden");
                }
                else if (response === "ERROR_SomeThingWentWrong") {
                    $("#DeletePayVisitModal #ERROR_SomeThingWentWrong").removeClass("hidden");
                    $(".loader").fadeIn("slow");
                    $(".loader").addClass("hidden");
                }
                else if (response === "AreYouSure") {
                    AskForDelete(Id);
                }
                else if (response === "CanNotDelete") {
                    CanNotDelete();
                } else {
                    $(".loader").fadeIn("slow");
                    $(".loader").addClass("hidden");
                }
            }
        });
    });


    function PeriodsChange() {

        var period = $("#periods").data("kendoDropDownList");

        var periodValue = period.value();
        var fromTo = $("#FromTo").text();

        if (periodValue === fromTo) {
            $("#DateFromDiv").removeClass("hidden");
            $("#DateToDiv").removeClass("hidden");
            $("#SearchBtnDiv").removeClass("hidden");

        } else {
            $("#DateFromDiv").addClass("hidden");
            $("#DateToDiv").addClass("hidden");
            $("#SearchBtnDiv").addClass("hidden");
            $("#kendoTotalReserveGrid").find(".k-pager-refresh").click();
        }
    }

    function btnSearchClick() {

        $("#kendoTotalReserveGrid").find(".k-pager-refresh").click();
    }

    function DeleteReserve(element) {

        bootbox.confirm('@Localizer["DeleteRecordBody"]', function (result) {

            if (!result) {
                return;
            } else {

                $(".loader").removeClass("hidden");
                var token = $(':input:hidden[name*="RequestVerificationToken"]');
                var Id = $(element).attr('data-id');

                var link = "/TotalReserves/Remove";

                $.ajax({
                    url: link,
                    type: "Post",
                    data: {
                        __RequestVerificationToken: token.attr('value'),
                        Id: Id
                    },
                    success: function (response) {
                        if (response === "SUCCESSFUL") {

                            $("#kendoTotalReserveGrid .k-pager-refresh")[0].click();

                        } else if (response === "ERROR_ThisRecordHasDependencyOnItInAnotherEntity") {

                            bootbox.alert({
                                message: '@Localizer["ERROR_ThisRecordHasDependencyOnItInAnotherEntity"]',
                                className: 'bootbox-class'
                            });

                        } else if (response === "Visited") {

                            bootbox.alert({
                                message: '@Localizer["ThisReserveAlreadyIsVisited"]',
                                className: 'bootbox-class'
                            });

                        } else {

                            bootbox.alert({
                                message: '@Localizer["ERROR_SomeThingWentWrong"]',
                                className: 'bootbox-class'
                            });
                        }

                        $(".loader").fadeIn("slow");
                        $(".loader").addClass("hidden");
                    }

                });
            }
        })
    }

</script>
