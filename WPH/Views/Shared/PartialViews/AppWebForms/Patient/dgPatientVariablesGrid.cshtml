@model WPH.Models.CustomDataModels.PatientVariable.PatientVariableViewModel


<style>

    .k-primary:hover {
        text-decoration: none;
    }
</style>


<div class="row" style="padding:2rem 1.3rem">

    <a class="k-primary" onClick="AddNewPatientVariable()" href="#" style="padding:1rem;font-size:1.5rem">
        @ViewBag.New
        <i class="ace-icon glyphicon  glyphicon-plus " style="transform:translateY(2px)"></i>

    </a>
</div>



<div>

    <table id="PatientVariablesGrid">

        <colgroup>
            <col style="width:50px;text-align:center" />
            <col style="width:150px;text-align:center" />
            @{
                foreach (var cli in Model.ClinicSectionChoosenValues)
                {
                    <col style="text-align:center" />
                }
            }
            <col style="width:50px;text-align:center" />
            <col style="width:50px;text-align:center" />
        </colgroup>



        <thead>

            <tr>

                <th data-field="index" style="text-align:center">#</th>
                <th data-field="date" style="text-align:center">Date</th>
                @{
                    foreach (var cli in Model.ClinicSectionChoosenValues)
                    {
                        <th data-field="@cli.VariableNameForView" style="text-align:center">@cli.PatientVariableVariableName</th>
                    }
                }
                <th data-field="edit" style="text-align:center"></th>
                <th data-field="delete" style="text-align:center"></th>
            </tr>

        </thead>

        <tbody>

            @{
                int i = 1;
                foreach (var List in Model.AllVariableValues)
                {
                    if (List.Count != 0)
                    {
                        <tr>
                            <td>@i</td>

                            <td>@List.FirstOrDefault().VariableInsertedDate.Value.ToShortDateString()</td>
                            @{
                                foreach (var value in List)
                                {
                                    <td data-id="@value.Guid">@value.Value<span class="hidden">@value.Guid</span></td>
                                }
                            }

                            <td>
                                <a class="grid-btn" onClick="EditPatientVariable(this)">
                                    <span class="green">
                                        <i class="ace-icon fa fa-pencil bigger-120"></i>
                                    </span>
                                </a>
                            </td>

                            <td>
                                <a class="grid-btn" onClick="DeletePatientVariable(this)">
                                    <span class="red">
                                        <i class="ace-icon fa fa-trash-can bigger-120"></i>
                                    </span>
                                </a>
                            </td>

                        </tr>
                    }

                    i++;
                }

            }

        </tbody>




    </table>

</div>


<div class="demo-section k-content col-xs-12" style="margin-top:2rem">
    @(Html.Kendo().Upload()
        .Name("files")
        .Multiple(true)

        .Async(a => a
            .Save("Async_Save", "Patient", new { patientId = Model.PatientId })
            .Remove("Async_Remove", "Patient")

            .AutoUpload(true)
        )
        .ShowFileList(false)

        .Events(events => events
                .Error("onPatientImageError")
                .Complete("onPatientImageComplete")

            )
    )
</div>


<div id="PatientImages" class="col-xs-12" style="margin:2rem 0">


</div>


<div>


    @(Html.Kendo().Window()
        .Name("window")
        //.Title("Image Preview")
        .Visible(false)
        .Content(@<text>
                    <img id="imagePreview" src="#" alt="Image Preview" height="500" />
        </text>)
.Draggable()
.Resizable()
.Actions(actions => actions.Pin().Minimize().Maximize().Close())
    )

</div>



<script>


    $(document).ready(function () {
        $("#PatientVariablesGrid").kendoGrid();
         $(".loader").removeClass("hidden");
        GetAllPatientImages();
    });


    function AddNewPatientVariable() {
        $(".loader").removeClass("hidden");
        $("#PatientVariableNewModal").modal('toggle');
        var patientid = $("#btn-PatientVariables-accept").attr('data-patientid');
        //$("#PatientVariables-modal-header").text(/*$("#PatientVariables-modal-header").text() + " - " + */$(element).attr('data-name'));

        $("#btn-PatientVariableNew-accept").attr('data-patientid', patientid);

        var link = "/Patient/NewPatientVariableModal?patientId=";
        $('#PatientVariableNewModal-body').load(link + patientid, function () {
            $(".loader").fadeIn("slow");
            $(".loader").addClass("hidden");
        });
    }


    function EditPatientVariable(element) {

        $(".loader").removeClass("hidden");

        $("#PatientVariableNewModal").modal('toggle');
        var patientid = $("#btn-PatientVariables-accept").attr('data-patientid');
        var allVariables = $(element).parent().prevAll();

        var allVariablesId = [];

        let rr = $(allVariables[1]).find('span').text();

        for (let i = 0; i < allVariables.length; i++) {
            if ($(allVariables[i]).attr('data-field') === "date")
                break;
            allVariablesId.push($(allVariables[i]).find('span').text());
        }

        $("#btn-PatientVariableNew-accept").attr('data-patientid', patientid);
        var link = "/Patient/EditPatientVariableModal?PatientId=";
        $('#PatientVariableNewModal-body').load(link + allVariablesId, function () {
            $(".loader").fadeIn("slow");
            $(".loader").addClass("hidden");
        });
    }

    function DeletePatientVariable(element) {



            bootbox.confirm('@ViewBag.DeleteBody', function (result) {


                if (!result) {

                    return;

                }
                else {

                    $(".loader").removeClass("hidden");

                    var allVariables = $(element).parent().prev().prevAll();

                    var allVariablesId = [];


                    for (let i = 0; i < allVariables.length; i++) {
                        if ($(allVariables[i]).attr('data-field') === "date")
                            break;
                        allVariablesId.push($(allVariables[i]).find('span').text());
                    }

                    var link = "/Patient/DeletePatientVariableModal";

                    $.ajax({

                        url: link,

                        type: "Post",

                        data: { PatientId: allVariablesId },

                        success: function (response) {

                            var patientid = $("#btn-PatientVariables-accept").attr('data-patientId');

                            var link = "/Patient/PatientVariableModal?patientId=";
                            $('#PatientVariables-modal-body').load(link + patientid, function () {
                                $(".loader").fadeIn("slow");
                                $(".loader").addClass("hidden");
                            });

                        }

                    });

                }
            })

    }

    function DeletePatientImage(element) {

        bootbox.confirm('Do you Want Delete This Image?', function (result) {
            
            if (!result) {

                return;

            }
            else {
                var Id = $(element).attr("data-Id");

                $(".loader").removeClass("hidden");
                $.ajax({

                    url: '/Patient/RemovePatientImage',

                    type: "Post",

                    data: { patientImageId: Id },

                    success: function () {

                        $("#PatientImages").html('');
                        GetAllPatientImages();
                        $(".loader").fadeIn("slow");
                        $(".loader").addClass("hidden");

                    }


                });
            }

        })

    }

    function GetAllPatientImages() {

        $("#PatientImages").html('');
        let pat = $("#btn-PatientVariables-accept").attr('data-patientid');
        $.ajax({

            url: '/Patient/GetAllPatientImages',

            type: "Post",

            data: { patientId: pat },

            success: function (eventList) {
                
                for (let i = 0; i < eventList.length; i++) {
                    $("<div class='col-xs-4 col-sm-2' style='text-align:center;margin-bottom:2rem'>"+
                        "<div style='margin-bottom:1rem'> <img src=" + eventList[i].ImageAddress + " width='150' height='150' ondblclick='openPic(this)' /></div>" +
                        "<h5>" + eventList[i].FileName + "</h5>"+
                        "<a class='k-primary grid-btn' style='margin-top:5rem'  onclick='DeletePatientImage(this)' data-Id =" + eventList[i].Guid + " > Delete </a>"+
                        "</div> ").appendTo($("#PatientImages"));
                }
               
                $(".loader").fadeIn("slow");
                $(".loader").addClass("hidden");

            }


        });

    }



    function openPic(e) {
        
        //var destenation = $(e).next().next().text();
        var destenation1 = $(e).attr('src');
        

        
        $("#imagePreview").attr("src", destenation1);
        $("#window").data("kendoWindow").center().open();
    }


</script>