@*@using Stimulsoft.Report.Mvc*@
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor
@inject WPH.Resources.SharedViewLocalizer Localizer




<div class="row page-header">
    <div class="@if (HttpContextAccessor.HttpContext.Session.GetString("culture") != "en") {
            @:pull-right
        }
        else {
        @:pull-left
        } ">
        <h1 class="@if (HttpContextAccessor.HttpContext.Session.GetString("culture") == "en") {
                                                                                    @:MyFont-Roboto-grid
                                                                                  } else {
                                                                                    @:MyFont-Sarchia-grid
                                                                                        }" style="font-size: 2.3rem">
            @Localizer["MedicineReport"]
        </h1>

    </div>
</div><!-- /.page-header -->


<div id="signup-box" class="signup-box no-border @if (HttpContextAccessor.HttpContext.Session.GetString("culture") == "en") {
                                                                                    @:MyFont-Roboto-grid
                                                                                  } else {
                                                                                    @:MyFont-Sarchia-grid
                                                                                        }">
    <div class="widget-body">
        <div class="widget-main">
            <form id="addNewForm">
                <fieldset>

                    <div class="col-xs-12" style="@if (HttpContextAccessor.HttpContext.Session.GetString("culture") != "en") {
            @:direction:rtl
                }
        else {
            @:ltr
        } ">

                        <div class="col-xs-6" style="padding:0">

                            <div class="col-sm-6" style="padding:0 1rem">

                                <label class="block clearfix">
                                    <label for="form-field-8">@Localizer["DateFrom"] : </label>
                                    <span class="block input-icon input-icon-right">
                                        <input id="FromDate" class="hidden" title="datepicker" style="width: 100%;font-size:1.5rem" type="date" />
                                        @(Html.Kendo().DatePicker()
                                          .Name("KendoFromDate")
                                          .Format("dd/MM/yyyy")
                                          .Value(DateTime.Now)
                                          .HtmlAttributes(new { style = "width: 100%", onchange = "dateTimePickerWorkWithSpace(this)" })
                                        )
                                    </span>

                                </label>

                            </div>

                            <div class="col-sm-6" style="padding:0 1rem">

                                <label class="block clearfix">
                                    <label for="form-field-8">@Localizer["DateTo"] : </label>
                                    <span class="block input-icon input-icon-right">
                                        <input id="ToDate" class="hidden" title="datepicker" style="width: 100%;font-size:1.5rem" type="date" />
                                        @(Html.Kendo().DatePicker()
                                          .Name("KendoDateTo")
                                          .Format("dd/MM/yyyy")
                                          .Value(DateTime.Now)
                                          .HtmlAttributes(new { style = "width: 100%", onchange = "dateTimePickerWorkWithSpace(this)" })
                                        )
                                    </span>

                                </label>

                            </div>

                        </div>

                        <script>

                            function OnSelectMedicineOrProducer(e) {

                                var DataItem = this.dataItem(e.item.index());
                                var id = this.element.attr('id');

                                if (id === "MedicineName") {
                                    $("#MedicineId").text(DataItem.Guid);
                                    return
                                }

                                if (id === "ProducerName") {
                                    $("#ProducerId").text(DataItem.Guid);
                                    return
                                }

                                
                            }




                        </script>

                        <div class="col-xs-6" style="padding:0">

                            <div class="col-sm-6" style="padding:0 1rem">

                                <label class="block clearfix">
                                    <label for="form-field-8">@Localizer["Medicine"] : </label>
                                    <span class="block input-icon input-icon-right">
                                        @(Html.Kendo().AutoComplete()
                                              .Name("MedicineName")
                                              .DataTextField("JoineryName")
                                              .Events(events => events.Select("OnSelectMedicineOrProducer"))
                                              .Filter("contains")
                                              .HighlightFirst(true)
                                              .ClearButton(false)
                                              .HtmlAttributes(new { @id = "MedicineName", style = "width:100%"})
                                              .DataSource(source =>
                                              {
                                                  source.Read(read =>
                                                  {
                                                      read.Action("GetAllMedicine", "Medicine");
                                                  })
                                                  .ServerFiltering(false);
                                              })
                                        )
                                    </span>

                                </label>

                            </div>

                            <div class="col-sm-6" style="padding:0 1rem">

                                <label class="block clearfix">
                                    <label for="form-field-8">@Localizer["Producer"] : </label>
                                    <span class="block input-icon input-icon-right">
                                        @(Html.Kendo().AutoComplete()
                                              .Name("ProducerName")
                                              .DataTextField("Name")
                                              .Events(events => events.Select("OnSelectMedicineOrProducer"))
                                              .Filter("contains")
                                              .HighlightFirst(true)
                                              .ClearButton(false)
                                              .HtmlAttributes(new { @id = "ProducerName", style = "width:100%"})
                                              .DataSource(source =>
                                              {
                                                  source.Read(read =>
                                                  {
                                                      read.Action("GetAllProducers", "BaseInfo");
                                                  })
                                                  .ServerFiltering(false);
                                              })
                                        )
                                    </span>

                                </label>

                            </div>

                        </div>

                    </div>


                    <div class="space-24"></div>
                </fieldset>
            </form>
        </div>
    </div><!-- /.widget-body -->
</div><!-- /.signup-box -->
<div class="col-sm-12">

    @{
        if (HttpContextAccessor.HttpContext.Session.GetString("culture") != "en")
        {
            @(Html.Kendo().Button()
                    .Name("btn-MedicineReport-accept")
                    .HtmlAttributes(new { style = "font-size:15px;height:35px;margin:2px;", type = "button", @class = "k-primary pull-right", onclick = "AcceptReport()" })
                    .Content(Localizer["Ok"]))
        }
        else
        {
            @(Html.Kendo().Button()
                    .Name("btn-MedicineReport-accept")
                    .HtmlAttributes(new { style = "font-size:15px;height:35px;margin:2px;", type = "button", @class = "k-primary pull-left", onclick = "AcceptReport()" })
                    .Content(Localizer["Ok"]))
        }
    }


</div>

<h3 class="hidden" id="MedicineId"></h3>
<h3 class="hidden" id="ProducerId"></h3>

@*<canvas id="reportImage" class="hidden"></canvas>*@
@await Html.PartialAsync("~/Views/Shared/PartialViews/InterfacePartials/_GridAndModalLinks.cshtml")
@await Html.PartialAsync("~/Views/Shared/PartialViews/InterfacePartials/_Modal.cshtml")


<script>



    //var canvas;
    $(document).ready(function () {

        var fromDate = $("#KendoFromDate").data("kendoDatePicker");
        fromDate.element.focus();
        fromDate.element.select();
        var toDate = $("#KendoDateTo").data("kendoDatePicker");

        var frDate = fromDate.value();
        var tDate = toDate.value();

        let frMonth = frDate.getMonth() + 1;
        let frDay = frDate.getDate();
        let toMonth = tDate.getMonth() + 1;
        let toDay = tDate.getDate();

        if (frMonth < 10)
            frMonth = "0" + frMonth;
        if (toMonth < 10)
            toMonth = "0" + toMonth;
        if (frDay < 10)
            frDay = "0" + frDay;
        if (toDay < 10)
            toDay = "0" + toDay;

        let from = frDate.getFullYear() + "-" + frMonth + "-" + frDay;
        let too = tDate.getFullYear() + "-" + toMonth + "-" + toDay;

        $("#FromDate").val(from);
        $("#ToDate").val(too);

    })




    $('#KendoFromDate').keypress(function (e) {

        if (e.which === 13 || e.which === 9) {
            let date = $("#KendoDateTo").data("kendoDatePicker");
            date.element.focus();
            //date.element.select();
        }


    });

    $('#KendoFromDate').focus(function (e) {

        let date = $("#KendoFromDate").data("kendoDatePicker");
        date.element.select();

    });

    $('#KendoDateTo').keypress(function (e) {

        if (e.which === 13 || e.which === 9) {
            $("#btn-CostReport-accept").focus();
        }

    });


    $('#KendoDateTo').focus(function (e) {

        let date = $("#KendoDateTo").data("kendoDatePicker");
        date.element.select();

    });


    function draw2(imgData) {

        "use strict";

        var dataUrl = [];
        for (let index = 0; index < imgData.allb.length; index++) {


            var img = new Image();
            img.src = "data:image/jpeg;base64," + imgData.allb[index];
            dataUrl.push(img.src)


        }

        printJS({ printable: dataUrl, type: 'image' });

    }

    $("#MedicineName").on('focus', function (e) {
        let medicineAuto = $("#MedicineName").data("kendoAutoComplete");
        let value = medicineAuto.value();
        medicineAuto.search(value);
    });

    $("#ProducerName").on('focus', function (e) {
        let producerAuto = $("#ProducerName").data("kendoAutoComplete");
        let value = producerAuto.value();
        producerAuto.search(value);
    });


    function AcceptReport() {

        var fromDate = $("#KendoFromDate").data("kendoDatePicker");
        var toDate = $("#KendoDateTo").data("kendoDatePicker");

        let medicineAuto = $("#MedicineName").data("kendoAutoComplete");
        let producerAuto = $("#ProducerName").data("kendoAutoComplete");

        var frDate = fromDate.value();
        var tDate = toDate.value();
        let frMonth = frDate.getMonth() + 1;
        let frDay = frDate.getDate();
        let toMonth = tDate.getMonth() + 1;
        let toDay = tDate.getDate();

        if (frMonth < 10)
            frMonth = "0" + frMonth;
        if (toMonth < 10)
            toMonth = "0" + toMonth;
        if (frDay < 10)
            frDay = "0" + frDay;
        if (toDay < 10)
            toDay = "0" + toDay;

        let from = frDate.getFullYear() + "-" + frMonth + "-" + frDay;
        let too = tDate.getFullYear() + "-" + toMonth + "-" + toDay;

        $("#FromDate").val(from);
        $("#ToDate").val(too);

        setTimeout(function () {



            let from = $("#FromDate").val();
            let to = $("#ToDate").val();
            let medicineId = $("#MedicineId").text();
            let producerId = $("#ProducerId").text();

            if (medicineAuto.value() === "" || medicineAuto.value() === null) {
                medicineId = "";
            }

            if (producerAuto.value() === "" || producerAuto.value() === null) {
                producerId = "";
            }


            var data = { fromDate: from, toDate: to, MedicineId: medicineId, ProducerId: producerId};
            link = "/MedicineReport/PrintMedicineReport";

            $(".loader").removeClass("hidden");

            $.ajax({
                url: link,
                type: "Post",
                data: data,
                success: function (response) {

                    draw2(response);
                    $(".loader").fadeIn("slow");
                    $(".loader").addClass("hidden");
                },
                error: function (response) {
                    console.log(response);
                    console.log(response.data);
                    console.log(response.error);
                }
            });


        }, 20);




    }


</script>
